<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .kanban-board {
            padding: 20px;
            overflow-x: auto;
        }
        
        .kanban-list {
            min-width: 300px;
            max-width: 300px;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .kanban-header {
            padding: 15px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .kanban-cards {
            padding: 15px;
            min-height: 400px;
        }
        
        .kanban-card {
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .kanban-card.completed {
            opacity: 0.7;
            background-color: #d4edda;
        }
        
        .card-deadline {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .card-deadline.overdue {
            color: #dc3545;
            font-weight: bold;
        }
        
        .drag-over {
            background-color: rgba(108, 117, 125, 0.1);
        }
        
        .add-card-btn {
            width: 100%;
            border: 2px dashed #6c757d;
            background: transparent;
            color: #6c757d;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .add-card-btn:hover {
            border-color: #495057;
            color: #495057;
            background-color: rgba(108, 117, 125, 0.1);
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-tasks me-2"></i>Kanban Board
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-primary me-2" onclick="showAddListModal()">
                    <i class="fas fa-plus me-1"></i>Add List
                </button>
                <a href="/summary" class="btn btn-primary">
                    <i class="fas fa-chart-bar me-1"></i>Summary
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="kanban-board">
            <div class="d-flex" id="kanban-container">
                <!-- Lists will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Add List Modal -->
    <div class="modal fade" id="addListModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addListForm">
                        <div class="mb-3">
                            <label for="listName" class="form-label">List Name</label>
                            <input type="text" class="form-control" id="listName" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addList()">Add List</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div class="modal fade" id="addCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCardForm">
                        <input type="hidden" id="cardListId">
                        <div class="mb-3">
                            <label for="cardTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="cardTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="cardContent" class="form-label">Content</label>
                            <textarea class="form-control" id="cardContent" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="cardDeadline" class="form-label">Deadline</label>
                            <input type="date" class="form-control" id="cardDeadline">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCard()">Add Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Card Modal -->
    <div class="modal fade" id="editCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCardForm">
                        <input type="hidden" id="editCardId">
                        <div class="mb-3">
                            <label for="editCardTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="editCardTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCardContent" class="form-label">Content</label>
                            <textarea class="form-control" id="editCardContent" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editCardDeadline" class="form-label">Deadline</label>
                            <input type="date" class="form-control" id="editCardDeadline">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editCardCompleted">
                                <label class="form-check-label" for="editCardCompleted">
                                    Mark as completed
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCard()">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateCard()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lists = [];
        let cards = [];
        let currentEditCardId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadLists();
            loadCards();
        });

        // Load all lists
        async function loadLists() {
            try {
                const response = await fetch('/api/lists');
                lists = await response.json();
                renderBoard();
            } catch (error) {
                console.error('Error loading lists:', error);
            }
        }

        // Load all cards
        async function loadCards() {
            try {
                const response = await fetch('/api/cards');
                cards = await response.json();
                renderBoard();
            } catch (error) {
                console.error('Error loading cards:', error);
            }
        }

        // Render the kanban board
        function renderBoard() {
            const container = document.getElementById('kanban-container');
            container.innerHTML = '';

            lists.forEach(list => {
                const listCards = cards.filter(card => card.list_id === list.id);
                const listElement = createListElement(list, listCards);
                container.appendChild(listElement);
            });
        }

        // Create list element
        function createListElement(list, listCards) {
            const listDiv = document.createElement('div');
            listDiv.className = 'kanban-list';
            listDiv.innerHTML = `
                <div class="kanban-header">
                    <h5 class="mb-0">${list.name}</h5>
                    <div>
                        <span class="badge bg-secondary">${listCards.length}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteList(${list.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="kanban-cards" data-list-id="${list.id}" ondrop="drop(event)" ondragover="allowDrop(event)">
                    ${listCards.map(card => createCardHTML(card)).join('')}
                    <button class="add-card-btn" onclick="showAddCardModal(${list.id})">
                        <i class="fas fa-plus me-2"></i>Add a card
                    </button>
                </div>
            `;
            return listDiv;
        }

        // Create card HTML
        function createCardHTML(card) {
            const isOverdue = card.deadline && new Date(card.deadline) < new Date() && !card.completed;
            const deadlineClass = isOverdue ? 'overdue' : '';
            const cardClass = card.completed ? 'kanban-card completed' : 'kanban-card';
            
            return `
                <div class="card ${cardClass}" draggable="true" ondragstart="drag(event)" data-card-id="${card.id}" onclick="editCard(${card.id})">
                    <div class="card-body">
                        <h6 class="card-title">${card.title}</h6>
                        ${card.content ? `<p class="card-text small">${card.content}</p>` : ''}
                        ${card.deadline ? `<p class="card-deadline ${deadlineClass}"><i class="far fa-calendar"></i> ${formatDate(card.deadline)}</p>` : ''}
                        ${card.completed ? '<i class="fas fa-check-circle text-success"></i>' : ''}
                    </div>
                </div>
            `;
        }

        // Format date for display
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        // Drag and drop functions
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.cardId);
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const cardId = ev.dataTransfer.getData("text");
            const newListId = parseInt(ev.currentTarget.dataset.listId);
            
            moveCard(cardId, newListId);
        }

        // Move card to different list
        async function moveCard(cardId, newListId) {
            try {
                const response = await fetch(`/api/cards/${cardId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        list_id: newListId
                    })
                });

                if (response.ok) {
                    loadCards(); // Only reload cards since we're just moving a card
                } else {
                    console.error('Error moving card:', response.status);
                    alert('Failed to move card');
                }
            } catch (error) {
                console.error('Error moving card:', error);
            }
        }

        // Modal functions
        function showAddListModal() {
            new bootstrap.Modal(document.getElementById('addListModal')).show();
        }

        function showAddCardModal(listId) {
            document.getElementById('cardListId').value = listId;
            new bootstrap.Modal(document.getElementById('addCardModal')).show();
        }

        // Add new list
        async function addList() {
            const name = document.getElementById('listName').value.trim();
            if (!name) return;

            try {
                const response = await fetch('/api/lists', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    document.getElementById('listName').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('addListModal')).hide();
                    loadLists();
                }
            } catch (error) {
                console.error('Error adding list:', error);
            }
        }

        // Add new card
        async function addCard() {
            const title = document.getElementById('cardTitle').value.trim();
            const content = document.getElementById('cardContent').value.trim();
            const deadline = document.getElementById('cardDeadline').value;
            const listId = parseInt(document.getElementById('cardListId').value);

            if (!title) return;

            try {
                const response = await fetch('/api/cards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        deadline: deadline || null,
                        list_id: listId
                    })
                });

                if (response.ok) {
                    document.getElementById('addCardForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addCardModal')).hide();
                    loadCards();
                }
            } catch (error) {
                console.error('Error adding card:', error);
            }
        }

        // Edit card
        function editCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if (!card) return;

            currentEditCardId = cardId;
            document.getElementById('editCardId').value = cardId;
            document.getElementById('editCardTitle').value = card.title;
            document.getElementById('editCardContent').value = card.content || '';
            document.getElementById('editCardDeadline').value = card.deadline || '';
            document.getElementById('editCardCompleted').checked = card.completed;

            new bootstrap.Modal(document.getElementById('editCardModal')).show();
        }

        // Update card
        async function updateCard() {
            const cardId = currentEditCardId;
            const title = document.getElementById('editCardTitle').value.trim();
            const content = document.getElementById('editCardContent').value.trim();
            const deadline = document.getElementById('editCardDeadline').value;
            const completed = document.getElementById('editCardCompleted').checked;

            if (!title) return;

            try {
                const response = await fetch(`/api/cards/${cardId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        deadline: deadline || null,
                        completed
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editCardModal')).hide();
                    loadCards();
                }
            } catch (error) {
                console.error('Error updating card:', error);
            }
        }

        // Delete card
        async function deleteCard() {
            if (!confirm('Are you sure you want to delete this card?')) return;

            const cardId = currentEditCardId;

            try {
                const response = await fetch(`/api/cards/${cardId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editCardModal')).hide();
                    loadCards();
                }
            } catch (error) {
                console.error('Error deleting card:', error);
            }
        }

        // Delete list
        async function deleteList(listId) {
            if (!confirm('Are you sure you want to delete this list and all its cards?')) return;

            try {
                const response = await fetch(`/api/lists/${listId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadLists();
                    loadCards();
                }
            } catch (error) {
                console.error('Error deleting list:', error);
            }
        }

        // Event listeners for drag and drop
        document.addEventListener('dragend', function(e) {
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        });

        // Logout function
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;

            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });

                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    console.error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                // Force redirect even if request fails
                window.location.href = '/login';
            }
        }

        // Manually create default lists (fallback function)
        async function createDefaultListsManually() {
            const defaultLists = ['To Do', 'In Progress', 'Done'];
            
            try {
                console.log('📝 Manually creating default lists...');
                
                for (const listName of defaultLists) {
                    console.log(`📝 Creating list: ${listName}`);
                    const response = await fetch('/api/lists', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: listName })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to create list: ${listName}`);
                    }
                }
                
                console.log('✅ Default lists created successfully!');
                
                // Reload the page to show the new lists
                await loadLists();
                
            } catch (error) {
                console.error('❌ Error creating default lists:', error);
                alert('Failed to create default lists: ' + error.message);
            }
        }
    </script>
</body>
</html>